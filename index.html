<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyVoice Maker - AIéŸ³å£°ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            display: flex;
            min-height: 100vh;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1f1f1f 100%);
            border-right: 2px solid #ff8800;
            box-shadow: 4px 0 20px rgba(255, 136, 0, 0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar h1 {
            color: #ff8800;
            font-size: 24px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 136, 0, 0.8);
            margin-bottom: 20px;
            border-bottom: 2px solid #ff8800;
            padding-bottom: 10px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff8800;
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.3);
            margin-bottom: 30px;
        }

        .header h2 {
            color: #ff8800;
            font-size: 28px;
            text-shadow: 0 0 10px rgba(255, 136, 0, 0.6);
        }

        /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            background: linear-gradient(135deg, #ff8800 0%, #ff6600 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 10px rgba(255, 136, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover:before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 136, 0, 0.6), inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(255, 136, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn:disabled {
            background: linear-gradient(135deg, #666 0%, #555 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒœã‚¿ãƒ³ */
        .sidebar .btn {
            width: 100%;
            margin-bottom: 10px;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.9);
            color: #ff8800;
            border: 1px solid #ff8800;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 2px solid #ff8800;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.3);
        }

        .card h3 {
            color: #ff8800;
            margin-bottom: 15px;
            font-size: 20px;
            text-shadow: 0 0 5px rgba(255, 136, 0, 0.5);
        }

        /* å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ« */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border: 2px dashed #ff8800;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            border-color: #ffaa00;
        }

        /* ãƒªã‚¹ãƒˆ */
        .slide-list {
            max-height: 400px;
            overflow-y: auto;
            background: #1a1a1a;
            border: 2px solid #ff8800;
            border-radius: 8px;
            padding: 10px;
        }

        .slide-item {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 1px solid #ff8800;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(255, 136, 0, 0.2);
        }

        .slide-index {
            background: linear-gradient(135deg, #ff8800 0%, #ff6600 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(255, 136, 0, 0.4);
        }

        .slide-script {
            flex: 1;
        }

        .slide-script textarea {
            width: 100%;
            min-height: 60px;
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #ff8800;
            border-radius: 5px;
            padding: 10px;
            font-family: inherit;
            resize: vertical;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 2px solid #ff8800;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            min-height: 60px;
            box-shadow: 0 2px 10px rgba(255, 136, 0, 0.3);
        }

        .status-text {
            color: #ff8800;
            font-size: 16px;
            font-weight: bold;
        }

        /* éŒ²éŸ³ä¸­ã®è¡¨ç¤º */
        .recording-status {
            display: none;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #ff8800 0%, #ff6600 100%);
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.5);
        }

        .recording-status.active {
            display: block;
        }

        .recording-pulse {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 50%;
            margin: 0 auto 15px;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* ãƒ˜ãƒ«ãƒ—ã‚¬ã‚¤ãƒ‰ */
        .help-guide {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 2px solid #ff8800;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.3);
        }

        .help-guide h4 {
            color: #ff8800;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .help-guide ul {
            list-style: none;
            padding-left: 0;
        }

        .help-guide li {
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }

        .help-guide li:last-child {
            border-bottom: none;
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-container {
            display: none;
            margin-top: 15px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #1a1a1a;
            border: 2px solid #ff8800;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff8800 0%, #ff6600 100%);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 136, 0, 0.5);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff8800 0%, #ff6600 100%);
            border-radius: 10px;
            border: 2px solid #1a1a1a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ffaa00 0%, #ff8800 100%);
        }

        /* éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        audio {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
        <h1>MyVoice Maker</h1>
        
        <button class="btn" id="csvInputBtn" data-tooltip="åŸç¨¿csvå…¥åŠ›">
            ğŸ“„ åŸç¨¿CSVå…¥åŠ›
        </button>
        
        <div style="margin-bottom: 10px;">
            <label style="color: #ff8800; font-size: 14px; display: block; margin-bottom: 5px;">éŒ²éŸ³æ™‚é–“ï¼ˆç§’ï¼‰</label>
            <input type="number" id="recordDuration" value="10" min="3" max="600" 
                   style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #ff8800; border-radius: 5px;" />
        </div>
        
        <button class="btn" id="recordBtn" data-tooltip="éŸ³å£°ã‚µãƒ³ãƒ—ãƒ«éŒ²éŸ³">
            ğŸ¤ éŒ²éŸ³
        </button>
        
        <button class="btn" id="generateBtn" data-tooltip="éŸ³å£°ç”Ÿæˆ">
            ğŸ”Š éŸ³å£°ç”Ÿæˆ
        </button>
        
        <button class="btn" id="playBtn" data-tooltip="éŸ³å£°å†ç”Ÿ" disabled>
            â–¶ï¸ éŸ³å£°å†ç”Ÿ
        </button>
        
        <button class="btn" id="csvOutputBtn" data-tooltip="åŸç¨¿csvå‡ºåŠ›">
            ğŸ’¾ åŸç¨¿CSVå‡ºåŠ›
        </button>
        
        <div class="status">
            <div class="status-text" id="statusText">æº–å‚™å®Œäº†</div>
        </div>

        <div class="recording-status" id="recordingStatus">
            <div class="recording-pulse"></div>
            <div style="color: white; font-weight: bold; font-size: 18px;">éŒ²éŸ³ä¸­...</div>
            <div id="recordingTime" style="color: white; margin-top: 10px;">00:00 / 00:00</div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="header">
            <h2>ğŸ™ï¸ AIéŸ³å£°ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h2>
            <p>Coqui TTS (XTTS v2) ã§è‡ªåˆ†ã®å£°ã‚’ä½¿ã£ãŸéŸ³å£°ç”Ÿæˆ</p>
        </div>

        <!-- åŸç¨¿å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
        <div class="card">
            <h3>ğŸ“ åŸç¨¿å…¥åŠ›</h3>
            <div class="file-input-wrapper">
                <input type="file" id="csvInput" accept=".csv" />
                <label for="csvInput" class="file-input-label">
                    ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </label>
            </div>
            <div id="csvFileName" style="margin-top: 10px; color: #ff8800;"></div>
        </div>

        <!-- ã‚¹ãƒ©ã‚¤ãƒ‰ãƒªã‚¹ãƒˆ -->
        <div class="card">
            <h3>ğŸ“‹ åŸç¨¿ãƒªã‚¹ãƒˆ</h3>
            <div class="slide-list" id="slideList">
                <p style="text-align: center; color: #888;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>
            </div>
        </div>

        <!-- éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
        <div class="card" id="audioPlayerCard" style="display: none;">
            <h3>ğŸµ éŸ³å£°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <audio id="audioPlayer" controls></audio>
        </div>

        <!-- ãƒ˜ãƒ«ãƒ—ã‚¬ã‚¤ãƒ‰ -->
        <div class="help-guide">
            <h4>ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h4>
            <ul>
                <li><strong>éŒ²éŸ³æ™‚é–“è¨­å®š:</strong> 3ã€œ300ç§’ã®ç¯„å›²ã§éŒ²éŸ³æ™‚é–“ã‚’æŒ‡å®šã§ãã¾ã™</li>
                <li><strong>åŸç¨¿CSVå…¥åŠ›:</strong> CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦inputãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã—ã¾ã™ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã¾ãŸã¯ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰</li>
                <li><strong>éŒ²éŸ³:</strong> ãƒã‚¤ã‚¯ã‹ã‚‰æŒ‡å®šæ™‚é–“ã®éŸ³å£°ã‚µãƒ³ãƒ—ãƒ«ã‚’éŒ²éŸ³ã—ã¾ã™ï¼ˆ3-10ç§’æ¨å¥¨ï¼‰</li>
                <li><strong>éŸ³å£°ç”Ÿæˆ:</strong> åŸç¨¿ã‹ã‚‰éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ï¼ˆoutput/tempã‚’ã‚¯ãƒªã‚¢å¾Œã€slide_000.mp3ç­‰ã‚’å‡ºåŠ›ï¼‰</li>
                <li><strong>éŸ³å£°å†ç”Ÿ:</strong> ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°ã‚’å†ç”Ÿã—ã¾ã™</li>
                <li><strong>åŸç¨¿CSVå‡ºåŠ›:</strong> ç·¨é›†ã—ãŸåŸç¨¿ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</li>
            </ul>
        </div>
    </div>

    <script>
        let currentSlides = [];
        const API_BASE = window.location.origin;

        // åˆæœŸåŒ–
        async function init() {
            // ã‚µãƒ¼ãƒãƒ¼ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                if (response.ok) {
                    updateStatus('ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæˆåŠŸ', 'success');
                }
            } catch (error) {
                updateStatus('ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¤±æ•—', 'error');
            }

            // TTSãƒ¢ãƒ‡ãƒ«ã‚’ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
            try {
                await fetch(`${API_BASE}/api/warmup_tts`, { method: 'POST' });
            } catch (error) {
                console.warn('TTS warmup failed:', error);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type = 'info') {
            const statusText = document.getElementById('statusText');
            statusText.textContent = message;
            statusText.style.color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#ff8800';
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        function updateProgress(percent, text = null) {
            const container = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (percent > 0) {
                container.classList.add('active');
                fill.style.width = `${percent}%`;
                progressText.textContent = text || `${Math.round(percent)}%`;
            } else {
                container.classList.remove('active');
            }
        }

        // CSVå…¥åŠ›ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒœã‚¿ãƒ³å¯¾å¿œï¼‰
        document.getElementById('csvInputBtn').addEventListener('click', () => {
            document.getElementById('csvInput').click();
        });

        // CSVå…¥åŠ›
        document.getElementById('csvInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('csvFileName').textContent = `é¸æŠ: ${file.name}`;
            updateStatus('CSVã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');

            try {
                // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/api/upload/csv`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`CSV upload failed: ${errorText}`);
                }

                // CSVã‚’è§£æï¼ˆæ–‡å­—åŒ–ã‘å¯¾ç­–ï¼šUTF-8, Shift-JISè‡ªå‹•åˆ¤å®šï¼‰
                const arrayBuffer = await file.arrayBuffer();
                let text;
                try {
                    // UTF-8ã§è©¦è¡Œ
                    text = new TextDecoder('utf-8').decode(arrayBuffer);
                } catch {
                    try {
                        // Shift-JISã§è©¦è¡Œ
                        text = new TextDecoder('shift-jis').decode(arrayBuffer);
                    } catch {
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è©¦è¡Œ
                        text = new TextDecoder().decode(arrayBuffer);
                    }
                }

                const lines = text.split(/\r?\n/).filter(line => line.trim());
                const slides = [];

                for (let i = 1; i < lines.length; i++) {
                    // CSVãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒã®å¾Œã®ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã‚’è€ƒæ…®ï¼‰
                    const match = lines[i].match(/^(\d+),\s*"?([^"]*)"?$/);
                    if (match) {
                        slides.push({
                            index: parseInt(match[1]),
                            script: match[2].trim()
                        });
                    }
                }

                if (slides.length === 0) {
                    throw new Error('æœ‰åŠ¹ãªåŸç¨¿ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                currentSlides = slides;
                renderSlides();
                updateStatus('CSVèª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } catch (error) {
                console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('CSVèª­ã¿è¾¼ã¿å¤±æ•—: ' + error.message, 'error');
            }
        });
Timer;

        document.getElementById('recordBtn').addEventListener('click', async () => {
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('recordingStatus');
            const durationInput = document.getElementById('recordDuration');
            const recordingDuration = parseInt(durationInput.value) || 10;

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // éŒ²éŸ³é–‹å§‹
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    recordedChunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) recordedChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const blob = new Blob(recordedChunks, { type: 'audio/wav' });
                        await uploadRecording(blob);
                        status.classList.remove('active');
                        btn.textContent = 'ğŸ¤ éŒ²éŸ³';
                        if (recordingTimer) clearInterval(recordingTimer);
                        
                        // ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    recordingStartTime = Date.now();
                    status.classList.add('active');
                    btn.textContent = 'â¹ï¸ åœæ­¢';
                    updateStatus('éŒ²éŸ³ä¸­...', 'info');

                    // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
                    recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                        const remaining = Math.max(0, recordingDuration - elapsed);
                        const total = recordingDuration;
                        document.getElementById('recordingTime').textContent = 
                            `${formatTime(total)} / ${formatTime(elapsed)} / ${formatTime(remaining)}`;

                        if (elapsed >= recordingDuration) {
                            clearInterval(recordingTimer);
                            if (mediaRecorder.state === 'recording') {
                                mediaRecorder.stop();
                            }
                        }
                    }, 100);
                } catch (error) {
                    updateStatus('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ' + error.message, 'error');
                    status.classList.remove('active');
                }
            } else {
                // éŒ²éŸ³åœæ­¢
                if (recordingTimer) clearInterval(recordingTimer);
                if (mediaRecorder.state === 'recording') {
            try {
                updateStatus('éŒ²éŸ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');
                
                // ç¾åœ¨ã®æ—¥æ™‚ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `sample_${timestamp}.wav`;
                
                const formData = new FormData();
                formData.append('file', blob, filename);

                const response = await fetch(`${API_BASE}/api/upload/recording`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`éŒ²éŸ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${errorText}`);
                }

                const result = await response.json();
                updateStatus(`éŒ²éŸ³ä¿å­˜å®Œäº†: ${result.filename}`, 'success');
            } catch (error) {
                console.error('éŒ²éŸ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);assList.add('active');
                const clearResponse = await fetch(`${API_BASE}/api/clear_temp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                if (!clearResponse.ok) {
                    console.warn('tempã‚¯ãƒªã‚¢è­¦å‘Š:', await clearResponse.text());
                }

                updateStatus('éŸ³å£°ç”Ÿæˆä¸­...', 'info');
                updateProgress(0);

                // å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®éŸ³å£°ã‚’ç”Ÿæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå»¶é•·ï¼‰
                for (let i = 0; i < currentSlides.length; i++) {
                    const slide = currentSlides[i];
                    updateProgress((i / currentSlides.length) * 100, `${i + 1}/${currentSlides.length}`);

                    if (!slide.script.trim()) continue;

                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’120ç§’ã«å»¶é•·
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 120000);

                    try {
                        const response = await fetch(`${API_BASE}/api/generate_audio`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                slide_index: slide.index,
                                script: slide.script,
                                resolution: '720p'
                            }),
                            signal: controller.signal
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`éŸ³å£°ç”Ÿæˆå¤±æ•— (ã‚¹ãƒ©ã‚¤ãƒ‰${slide.index}): ${errorText}`);
                        }
                    } catch (error) {
                        clearTimeout(timeoutId);
                        if (error.name === 'AbortError') {
                            throw new Error(`ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (ã‚¹ãƒ©ã‚¤ãƒ‰${slide.index}): 120ç§’çµŒé`);
                        }
                        throw error;
                    }
                }

                updateProgress(100, 'å®Œäº†');
                updateStatus('éŸ³å£°ç”Ÿæˆå®Œäº†', 'success');
                document.getElementById('playBtn').disabled = false;
                
                setTimeout(() => updateProgress(0), 2000);
            } catch (error) {
                console.error('éŸ³å£°ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);å´ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
                updateStatus('éŒ²éŸ³ä¿å­˜å®Œäº†', 'success');
            } catch (error) {
                updateStatus('éŒ²éŸ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + error.message, 'error');
            }
        }

        // éŸ³å£°ç”Ÿæˆ
        document.getElementById('generateBtn').addEventListener('click', async () => {
            if (currentSlides.length === 0) {
                updateStatus('åŸç¨¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            updateStatus('output/tempã‚’ã‚¯ãƒªã‚¢ä¸­...', 'info');

            try {
                // tempãƒ•ã‚©ãƒ«ãƒ€ã‚’ã‚¯ãƒªã‚¢
                await fetch(`${API_BASE}/api/clear_temp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                updateStatus('éŸ³å£°ç”Ÿæˆä¸­...', 'info');
                updateProgress(0);

                // å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®éŸ³å£°ã‚’ç”Ÿæˆ
                for (let i = 0; i < currentSlides.length; i++) {
                    const slide = currentSlides[i];
                    updateProgress((i / currentSlides.length) * 100, `${i + 1}/${currentSlides.length}`);

                    if (!slide.script.trim()) continue;

                    const response = await fetch(`${API_BASE}/api/generate_audio`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            slide_index: slide.index,
                            script: slide.script,
                            resolution: '720p'
                        }),
                        timeout: 60000 // 60ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
                    });

                    if (!response.ok) {
                        throw new Error(`éŸ³å£°ç”Ÿæˆå¤±æ•— (ã‚¹ãƒ©ã‚¤ãƒ‰${slide.index})`);
                    }
                }

                updateProgress(100, 'å®Œäº†');
                updateStatus('éŸ³å£°ç”Ÿæˆå®Œäº†', 'success');
                document.getElementById('playBtn').disabled = false;
                
                setTimeout(() => updateProgress(0), 2000);
            } catch (error) {
                updateStatus('éŸ³å£°ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
                updateProgress(0);
            }
        });

        // éŸ³å£°å†ç”Ÿ
        document.getElementById('playBtn').addEventListener('click', () => {
            if (currentSlides.length === 0) return;

            const audioPlayer = document.getElementById('audioPlayer');
            const audioCard = document.getElementById('audioPlayerCard');
            
            // æœ€åˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã®éŸ³å£°ã‚’å†ç”Ÿ
            audioPlayer.src = `${API_BASE}/output/temp/slide_000.mp3`;
            audioCard.style.display = 'block';
            audioPlayer.play();
            updateStatus('éŸ³å£°å†ç”Ÿä¸­', 'info');
        });

        // CSVå‡ºåŠ›
        document.getElementById('csvOutputBtn').addEventListener('click', () => {
            if (currentSlides.length === 0) {
                updateStatus('åŸç¨¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            let csvContent = 'index,script\n';
            currentSlides.forEach(slide => {
                csvContent += `${slide.index},"${slide.script}"\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'åŸç¨¿.csv';
            link.click();
            
            updateStatus('CSVå‡ºåŠ›å®Œäº†', 'success');
        });

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
        const dropZone = document.querySelector('.file-input-label');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ffaa00';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '#ff8800';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#ff8800';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('csvInput').files = files;
                document.getElementById('csvInput').dispatchEvent(new Event('change'));
            }
        });

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>
</html>
