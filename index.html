<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyVoice Maker - AIéŸ³å£°ç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            display: flex;
            min-height: 100vh;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1f1f1f 100%);
            border-right: 2px solid #ff8800;
            box-shadow: 4px 0 20px rgba(255, 136, 0, 0.3);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar h1 {
            color: #ff8800;
            font-size: 24px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 136, 0, 0.8);
            margin-bottom: 20px;
            border-bottom: 2px solid #ff8800;
            padding-bottom: 10px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .header {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ff8800;
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.3);
            margin-bottom: 30px;
        }

        .header h2 {
            color: #ff8800;
            font-size: 28px;
            text-shadow: 0 0 10px rgba(255, 136, 0, 0.6);
        }

        /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .btn {
            background: linear-gradient(135deg, #ff8800 0%, #ff6600 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            box-shadow: 0 4px 10px rgba(255, 136, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover:before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 136, 0, 0.6), inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(255, 136, 0, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .btn:disabled {
            background: linear-gradient(135deg, #666 0%, #555 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒœã‚¿ãƒ³ */
        .sidebar .btn {
            width: 100%;
            margin-bottom: 10px;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.9);
            color: #ff8800;
            border: 1px solid #ff8800;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 2px solid #ff8800;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.3);
        }

        .card h3 {
            color: #ff8800;
            margin-bottom: 15px;
            font-size: 20px;
            text-shadow: 0 0 5px rgba(255, 136, 0, 0.5);
        }

        /* å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ« */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            border: 2px dashed #ff8800;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            border-color: #ffaa00;
        }

        /* ãƒªã‚¹ãƒˆ */
        .script-list {
            max-height: 400px;
            overflow-y: auto;
            background: #1a1a1a;
            border: 2px solid #ff8800;
            border-radius: 8px;
            padding: 10px;
        }

        .script-item {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 1px solid #ff8800;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(255, 136, 0, 0.2);
        }

        .row-index {
            background: linear-gradient(135deg, #ff8800 0%, #ff6600 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(255, 136, 0, 0.4);
        }

        .row-script {
            flex: 1;
        }

        .row-script textarea {
            width: 100%;
            min-height: 60px;
            background: #1a1a1a;
            color: #e0e0e0;
            border: 1px solid #ff8800;
            border-radius: 5px;
            padding: 10px;
            font-family: inherit;
            resize: vertical;
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 2px solid #ff8800;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            min-height: 60px;
            box-shadow: 0 2px 10px rgba(255, 136, 0, 0.3);
        }

        .status-text {
            color: #ff8800;
            font-size: 16px;
            font-weight: bold;
        }

        /* éŒ²éŸ³ä¸­ã®è¡¨ç¤º */
        .recording-status {
            display: none;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #ff8800 0%, #ff6600 100%);
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.5);
        }

        .recording-status.active {
            display: block;
        }

        .recording-pulse {
            width: 60px;
            height: 60px;
            background: #fff;
            border-radius: 50%;
            margin: 0 auto 15px;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* ãƒ˜ãƒ«ãƒ—ã‚¬ã‚¤ãƒ‰ */
        .help-guide {
            background: linear-gradient(135deg, #2a2a2a 0%, #3a3a3a 100%);
            border: 2px solid #ff8800;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 136, 0, 0.3);
        }

        .help-guide h4 {
            color: #ff8800;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .help-guide ul {
            list-style: none;
            padding-left: 0;
        }

        .help-guide li {
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }

        .help-guide li:last-child {
            border-bottom: none;
        }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-container {
            display: none;
            margin-top: 15px;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #1a1a1a;
            border: 2px solid #ff8800;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff8800 0%, #ff6600 100%);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(255, 136, 0, 0.5);
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ff8800 0%, #ff6600 100%);
            border-radius: 10px;
            border: 2px solid #1a1a1a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #ffaa00 0%, #ff8800 100%);
        }

        /* éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        audio {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
        <h1>MyVoice Maker</h1>

        <div id="sidebarInfo" style="color:#ff8800; font-size:14px; text-align:center; margin-top:-10px; margin-bottom:10px;">
            index: - / -
        </div>
        
        <button class="btn" id="csvInputBtn" data-tooltip="åŸç¨¿csvå…¥åŠ›">
            ğŸ“„ åŸç¨¿CSVå…¥åŠ›
        </button>

        <!-- é‡è¤‡UIã‚’é¿ã‘ã‚‹ãŸã‚ã€CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒœã‚¿ãƒ³ã‹ã‚‰è¡Œã† -->
        <input type="file" id="csvInput" accept=".csv" style="display:none" />
        <div id="csvFileName" style="margin-top: 6px; color: #ff8800; font-size: 12px;"></div>
        
        <div style="margin-bottom: 10px;">
            <label style="color: #ff8800; font-size: 14px; display: block; margin-bottom: 5px;">éŒ²éŸ³æ™‚é–“ï¼ˆç§’ï¼‰</label>
            <input type="number" id="recordDuration" value="10" min="3" max="600" 
                   style="width: 100%; padding: 8px; background: #2a2a2a; color: #e0e0e0; border: 1px solid #ff8800; border-radius: 5px;" />
        </div>
        
        <button class="btn" id="recordBtn" data-tooltip="éŸ³å£°ã‚µãƒ³ãƒ—ãƒ«éŒ²éŸ³">
            ğŸ¤ éŒ²éŸ³
        </button>

        <button class="btn" id="buildModelBtn" data-tooltip="éŸ³å£°ç”Ÿæˆãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰">
            ğŸ§  éŸ³å£°ç”Ÿæˆãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰
        </button>
        
        <button class="btn" id="generateBtn" data-tooltip="éŸ³å£°ç”Ÿæˆ">
            ğŸ”Š éŸ³å£°ç”Ÿæˆ
        </button>

        <button class="btn" id="csvExportBtn" data-tooltip="åŸç¨¿csvå‡ºåŠ›">
            ğŸ’¾ åŸç¨¿CSVå‡ºåŠ›
        </button>
        
        <div class="status">
            <div class="status-text" id="statusText">æº–å‚™å®Œäº†</div>
        </div>

        <div class="recording-status" id="recordingStatus">
            <div class="recording-pulse"></div>
            <div style="color: white; font-weight: bold; font-size: 18px;">éŒ²éŸ³ä¸­...</div>
            <div id="recordingTime" style="color: white; margin-top: 10px;">00:00 / 00:00</div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-text" id="progressText">0%</div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="header">
            <h2>ğŸ™ï¸ AIéŸ³å£°ç”Ÿæˆãƒ„ãƒ¼ãƒ«</h2>
            <p>Coqui TTS (XTTS v2) ã§è‡ªåˆ†ã®å£°ã‚’ä½¿ã£ãŸéŸ³å£°ç”Ÿæˆ</p>
        </div>

        <!-- åŸç¨¿ãƒªã‚¹ãƒˆ -->
        <div class="card">
            <h3>ğŸ“‹ åŸç¨¿ãƒªã‚¹ãƒˆ</h3>
            <div class="script-list" id="scriptList">
                <p style="text-align: center; color: #888;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>
            </div>
        </div>

        <!-- éŸ³å£°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
        <div class="card" id="audioPlayerCard" style="display: none;">
            <h3>ğŸµ éŸ³å£°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <audio id="audioPlayer" controls></audio>
        </div>

        <!-- ãƒ˜ãƒ«ãƒ—ã‚¬ã‚¤ãƒ‰ -->
        <div class="help-guide">
            <h4>ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h4>
            <ul>
                <li><strong>éŒ²éŸ³æ™‚é–“è¨­å®š:</strong> 3ã€œ600ç§’ã®ç¯„å›²ã§éŒ²éŸ³æ™‚é–“ã‚’æŒ‡å®šã§ãã¾ã™</li>
                <li><strong>åŸç¨¿CSVå…¥åŠ›:</strong> CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦inputãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã—ã¾ã™ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰</li>
                <li><strong>åŸç¨¿CSVå‡ºåŠ›:</strong> ç¾åœ¨ã®åŸç¨¿CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰</li>
                <li><strong>éŒ²éŸ³:</strong> ãƒã‚¤ã‚¯ã‹ã‚‰æŒ‡å®šæ™‚é–“ã®éŸ³å£°ã‚µãƒ³ãƒ—ãƒ«ã‚’éŒ²éŸ³ã—ã¾ã™ï¼ˆ3-600ç§’ï¼‰</li>
                <li><strong>éŸ³å£°ç”Ÿæˆãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰:</strong> éŒ²éŸ³ã—ãŸå£°ï¼ˆè©±è€…WAVï¼‰ã‚’ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã€TTSã‚’äº‹å‰ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</li>
                <li><strong>éŸ³å£°ç”Ÿæˆ:</strong> åŸç¨¿ã‹ã‚‰éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ï¼ˆoutput/tempã‚’ã‚¯ãƒªã‚¢å¾Œã€voice_000.mp3ç­‰ã‚’å‡ºåŠ›ï¼‰</li>
                <li><strong>éŸ³å£°å†ç”Ÿ:</strong> ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°ã‚’å†ç”Ÿã—ã¾ã™</li>
            </ul>
        </div>
    </div>

    <script>
        let currentRows = [];
        // file:// ã§ç›´æ¥é–‹ã‹ã‚ŒãŸå ´åˆã¯ origin ãŒ "null" ã«ãªã‚‹ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«APIã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const API_BASE = (window.location.origin && window.location.origin !== 'null')
            ? window.location.origin
            : 'http://127.0.0.1:8000';

        // ç”Ÿæˆç‰©ã®æ··ç·š/ãƒ­ãƒƒã‚¯å›é¿ã®ãŸã‚ã€runã”ã¨ã« temp ã‚¹ã‚³ãƒ¼ãƒ—ã‚’åˆ‡ã‚‹
        let currentScope = null;
        let firstPlayableAudioUrl = null;

        // äºˆæœŸã›ã¬JSä¾‹å¤–ã§ãƒœã‚¿ãƒ³ãŒã€Œç„¡åå¿œã€ã«ãªã‚‹ã®ã‚’é˜²ãï¼ˆUIã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ï¼‰
        window.addEventListener('error', (ev) => {
            try {
                updateStatus(`JavaScriptã‚¨ãƒ©ãƒ¼: ${ev.message}`, 'error');
            } catch {
                // ignore
            }
        });
        window.addEventListener('unhandledrejection', (ev) => {
            try {
                const msg = (ev && ev.reason) ? (ev.reason.message || String(ev.reason)) : 'unknown';
                updateStatus(`Promiseã‚¨ãƒ©ãƒ¼: ${msg}`, 'error');
            } catch {
                // ignore
            }
        });

        function newScope(prefix = 'run') {
            const ts = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            return `${prefix}_${ts}`;
        }

        function escapeHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderRows() {
            const list = document.getElementById('scriptList');
            const info = document.getElementById('sidebarInfo');

            if (!Array.isArray(currentRows) || currentRows.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #888;">åŸç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                info.textContent = 'index: - / -';
                return;
            }

            // indexé †ã«æ•´åˆ—
            currentRows = [...currentRows].sort((a, b) => (a.index ?? 0) - (b.index ?? 0));
            info.textContent = `index: 0-${currentRows.length - 1} / ${currentRows.length}`;

            const frag = document.createDocumentFragment();
            currentRows.forEach((row) => {
                const item = document.createElement('div');
                item.className = 'script-item';

                const idx = document.createElement('div');
                idx.className = 'row-index';
                idx.textContent = String(row.index).padStart(3, '0');

                const scriptBox = document.createElement('div');
                scriptBox.className = 'row-script';

                const ta = document.createElement('textarea');
                ta.value = row.script ?? '';
                ta.placeholder = 'åŸç¨¿ã‚’å…¥åŠ›...';
                ta.addEventListener('input', (e) => {
                    row.script = e.target.value;
                });

                const generateRowBtn = document.createElement('button');
                generateRowBtn.className = 'btn';
                generateRowBtn.style.padding = '8px 12px';
                generateRowBtn.style.fontSize = '14px';
                generateRowBtn.textContent = 'éŸ³å£°ç”Ÿæˆ';
                generateRowBtn.title = 'ã“ã®è¡Œã ã‘éŸ³å£°ç”Ÿæˆï¼ˆä¸Šæ›¸ãï¼‰';
                generateRowBtn.addEventListener('click', async (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();

                    const idx = row.index;
                    const script = (row && row.script !== undefined) ? String(row.script) : '';
                    await generateOneRow(idx, script, generateRowBtn);
                });

                const playRowBtn = document.createElement('button');
                playRowBtn.className = 'btn';
                playRowBtn.style.padding = '8px 12px';
                playRowBtn.style.fontSize = '14px';
                playRowBtn.textContent = 'éŸ³å£°å†ç”Ÿ';
                playRowBtn.title = 'ã“ã®è¡Œã®éŸ³å£°ã‚’å†ç”Ÿï¼ˆæ—¢å­˜ã® mp3 ã‚’å†ç”Ÿï¼‰';
                playRowBtn.addEventListener('click', (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();
                    playAudioByIndex(row.index);
                });

                scriptBox.appendChild(ta);
                item.appendChild(idx);
                item.appendChild(scriptBox);
                item.appendChild(generateRowBtn);
                item.appendChild(playRowBtn);
                frag.appendChild(item);
            });

            list.innerHTML = '';
            list.appendChild(frag);
        }

        function audioUrlForIndex(index) {
            const idx = String(index ?? 0).padStart(3, '0');
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å¤ã„éŸ³å£°ãŒå†ç”Ÿã•ã‚Œã‚‹ã®ã‚’é¿ã‘ã‚‹
            return `${API_BASE}/output/voice_${idx}.mp3?v=${Date.now()}`;
        }

        function playAudioByIndex(index) {
            const audioPlayer = document.getElementById('audioPlayer');
            const audioCard = document.getElementById('audioPlayerCard');

            audioPlayer.src = audioUrlForIndex(index);
            audioCard.style.display = 'block';
            audioPlayer.play();
            updateStatus(`éŸ³å£°å†ç”Ÿä¸­: ${String(index).padStart(3, '0')}`, 'info');
        }

        async function generateOneRow(index, script, buttonEl = null) {
            if (!script || String(script).trim().length === 0) {
                updateStatus('ã“ã®è¡Œã®åŸç¨¿ãŒç©ºã§ã™', 'error');
                return;
            }

            // å†ç”Ÿä¸­ã®éŸ³å£°ãŒã‚ã‚‹ã¨ Windows ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã€ä¸Šæ›¸ãã«å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
            try {
                const ap = document.getElementById('audioPlayer');
                ap.pause();
                ap.removeAttribute('src');
                ap.load();
            } catch {
                // ignore
            }

            const genBtn = document.getElementById('generateBtn');
            const buildBtn = document.getElementById('buildModelBtn');
            const csvBtn = document.getElementById('csvInputBtn');
            const csvExportBtn = document.getElementById('csvExportBtn');
            const recBtn = document.getElementById('recordBtn');

            const disableTargets = [genBtn, buildBtn, csvBtn, csvExportBtn, recBtn, buttonEl].filter(Boolean);
            disableTargets.forEach(b => { try { b.disabled = true; } catch {} });

            updateStatus('éŸ³å£°ç”Ÿæˆä¸­ï¼ˆå‡¦ç†ä¸­ 0/1ï¼‰', 'info');
            updateProgress(10, 'å‡¦ç†ä¸­ 0/1');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000);
                // åˆå›ã¯ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–ã§é•·æ™‚é–“ã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€202(warming) ã‚’å¾…ã¡åˆã‚ã›ã§å¸åã™ã‚‹
                let res = null;
                for (let attempt = 0; attempt < 600; attempt++) { // æœ€å¤§ç´„20åˆ†
                    res = await fetch(`${API_BASE}/api/generate_audio`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ index: index, script: script, overwrite: true }),
                        signal: controller.signal,
                    });

                    if (res.status === 202) {
                        let j = null;
                        try { j = await res.json(); } catch { j = null; }
                        const stage = (j && j.tts && j.tts.stage) ? String(j.tts.stage) : 'warming';
                        updateStatus(`ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–ä¸­: ${stage}ï¼ˆå‡¦ç†ä¸­ 0/1ï¼‰`, 'info');
                        updateProgress(10, `åˆæœŸåŒ–ä¸­: ${stage}`);
                        await new Promise(r => setTimeout(r, 2000));
                        continue;
                    }

                    break;
                }
                clearTimeout(timeoutId);

                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(t);
                }

                updateProgress(100, 'å®Œäº†');
                updateStatus(`éŸ³å£°ç”Ÿæˆå®Œäº†: ${String(index).padStart(3, '0')}`, 'success');
                setTimeout(() => updateProgress(0), 1500);
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateStatus('éŸ³å£°ç”Ÿæˆå¤±æ•—: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ600ç§’è¶…éï¼‰', 'error');
                } else {
                    updateStatus('éŸ³å£°ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
                }
                updateProgress(0);
            } finally {
                disableTargets.forEach(b => { try { b.disabled = false; } catch {} });
            }
        }

        function detectAndDecodeCsv(arrayBuffer) {
            // UTF-8 ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚‚ä¾‹å¤–ã«ãªã‚‰ãªã„ãŸã‚ã€ç½®æ›æ–‡å­—ã®æ¯”ç‡ã§åˆ¤å®šã—ã¦ Shift_JIS ã‚’è©¦ã™
            const utf8 = new TextDecoder('utf-8').decode(arrayBuffer);
            const bad = (utf8.match(/\uFFFD/g) || []).length;
            const ratio = utf8.length ? bad / utf8.length : 0;
            if (ratio > 0.01) {
                try {
                    return new TextDecoder('shift_jis').decode(arrayBuffer);
                } catch {
                    // fallthrough
                }
            }
            return utf8;
        }

        function parseCsvRFC4180(text) {
            // æœ€å°é™ã® RFC4180 å¯¾å¿œï¼ˆå¼•ç”¨ç¬¦ã€æ”¹è¡Œã€ã‚«ãƒ³ãƒï¼‰
            const rows = [];
            let row = [];
            let field = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const c = text[i];

                if (inQuotes) {
                    if (c === '"') {
                        const next = text[i + 1];
                        if (next === '"') {
                            field += '"';
                            i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        field += c;
                    }
                    continue;
                }

                if (c === '"') {
                    inQuotes = true;
                    continue;
                }

                if (c === ',') {
                    row.push(field);
                    field = '';
                    continue;
                }

                if (c === '\n') {
                    row.push(field);
                    rows.push(row);
                    row = [];
                    field = '';
                    continue;
                }

                if (c === '\r') {
                    // ignore (\r\n å¯¾å¿œ)
                    continue;
                }

                field += c;
            }

            // last field
            row.push(field);
            rows.push(row);

            // æœ«å°¾ã®ç©ºè¡Œã‚’é™¤å»
            return rows.filter(r => r.some(v => String(v).trim() !== ''));
        }

        // åˆæœŸåŒ–
        async function init() {
            // ã‚µãƒ¼ãƒãƒ¼ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                if (response.ok) {
                    updateStatus('ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šæˆåŠŸ', 'success');
                }
            } catch (error) {
                updateStatus('ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¤±æ•—', 'error');
            }

            // TTSãƒ¢ãƒ‡ãƒ«ã‚’ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
            try {
                await fetch(`${API_BASE}/api/warmup_tts`, { method: 'POST' });
            } catch (error) {
                console.warn('TTS warmup failed:', error);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type = 'info') {
            const statusText = document.getElementById('statusText');
            statusText.textContent = message;
            statusText.style.color = type === 'error' ? '#ff4444' : type === 'success' ? '#44ff44' : '#ff8800';
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
        function updateProgress(percent, text = null) {
            const container = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            if (percent > 0) {
                container.classList.add('active');
                fill.style.width = `${percent}%`;
                progressText.textContent = text || `${Math.round(percent)}%`;
            } else {
                container.classList.remove('active');
            }
        }

        // æ™‚åˆ»è¡¨ç¤ºã‚’ mm:ss ã«æ•´å½¢
        function formatTime(sec) {
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = Math.floor(sec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStartTime = 0;
        let recordingTimer = null;
        let activeStream = null;

        async function uploadRecording(blob, filename = null) {
            const ts = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            // å½¢å¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å®Ÿè£…ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€æ‹¡å¼µå­ã«ä¾å­˜ã›ãšã‚µãƒ¼ãƒãƒ¼å´ã§WAVã¸æ­£è¦åŒ–ã—ã¦ä¿å­˜ã™ã‚‹
            const safeName = filename || `sample_${ts}.bin`;

            const formData = new FormData();
            formData.append('file', blob, safeName);

            const res = await fetch(`${API_BASE}/api/upload/recording`, {
                method: 'POST',
                body: formData
            });

            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(`éŒ²éŸ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${errorText}`);
            }

            const result = await res.json();
            updateStatus(`éŒ²éŸ³ä¿å­˜å®Œäº†: ${result.filename}`, 'success');
            return result.filename;
        }

        // CSVå…¥åŠ›ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒœã‚¿ãƒ³å¯¾å¿œï¼‰
        document.getElementById('csvInputBtn').addEventListener('click', () => {
            document.getElementById('csvInput').click();
        });

        // CSVå‡ºåŠ›ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
        document.getElementById('csvExportBtn').addEventListener('click', async () => {
            const btn = document.getElementById('csvExportBtn');
            btn.disabled = true;
            updateStatus('CSVã‚’æ›¸ãå‡ºã—ä¸­...', 'info');
            try {
                const res = await fetch(`${API_BASE}/api/export/csv`);
                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(t);
                }
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'åŸç¨¿.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                updateStatus('CSVå‡ºåŠ›å®Œäº†', 'success');
            } catch (e) {
                updateStatus('CSVå‡ºåŠ›å¤±æ•—: ' + (e && e.message ? e.message : String(e)), 'error');
            } finally {
                btn.disabled = false;
            }
        });

        // CSVå…¥åŠ›
        document.getElementById('csvInput').addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;

            // é€£ç¶šã§åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã³ç›´ã›ã‚‹ã‚ˆã†ã«ã€æ—©ã‚ã«å€¤ã‚’ã‚¯ãƒªã‚¢
            e.target.value = '';

            document.getElementById('csvFileName').textContent = `é¸æŠ: ${file.name}`;
            updateStatus('CSVã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');

            try {
                const formData = new FormData();
                formData.append('file', file);

                // CSVèª­ã¿è¾¼ã¿æ™‚ç‚¹ã§å†ç”ŸURLã‚’ãƒªã‚»ãƒƒãƒˆ
                firstPlayableAudioUrl = null;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                const response = await fetch(`${API_BASE}/api/upload/csv`, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal,
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`CSV upload failed: ${errorText}`);
                }

                const data = await response.json();
                const rows = (data && data.rows) ? data.rows : [];
                if (!Array.isArray(rows) || rows.length === 0) {
                    throw new Error('æœ‰åŠ¹ãªåŸç¨¿ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

                currentRows = rows;
                renderRows();
                updateStatus('CSVèª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } catch (error) {
                console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus('CSVèª­ã¿è¾¼ã¿å¤±æ•—: ' + error.message, 'error');
            }
        });

        // éŒ²éŸ³
        document.getElementById('recordBtn').addEventListener('click', async () => {
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('recordingStatus');
            const durationInput = document.getElementById('recordDuration');
            let recordingDuration = parseInt(durationInput.value) || 10;
            recordingDuration = Math.min(600, Math.max(3, recordingDuration));
            durationInput.value = recordingDuration;

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    activeStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(activeStream);
                    recordedChunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) recordedChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        try {
                            // å®Ÿä½“ã¯ MediaRecorder ã®ã‚³ãƒ³ãƒ†ãƒŠå½¢å¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å®Ÿè£…ä¾å­˜ï¼‰
                            const mime = mediaRecorder.mimeType || (recordedChunks[0] && recordedChunks[0].type) || 'application/octet-stream';
                            const blob = new Blob(recordedChunks, { type: mime });
                            await uploadRecording(blob);
                        } catch (err) {
                            updateStatus('éŒ²éŸ³ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + err.message, 'error');
                        } finally {
                            status.classList.remove('active');
                            btn.textContent = 'ğŸ¤ éŒ²éŸ³';
                            if (recordingTimer) clearInterval(recordingTimer);
                            if (activeStream) {
                                activeStream.getTracks().forEach(t => t.stop());
                                activeStream = null;
                            }
                        }
                    };

                    mediaRecorder.start();
                    recordingStartTime = Date.now();
                    status.classList.add('active');
                    btn.textContent = 'â¹ï¸ åœæ­¢';
                    updateStatus('éŒ²éŸ³ä¸­...', 'info');

                    recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                        const remaining = Math.max(0, recordingDuration - elapsed);
                        const total = recordingDuration;
                        document.getElementById('recordingTime').textContent =
                            `å…¨ ${formatTime(total)} / çµŒé ${formatTime(elapsed)} / æ®‹ ${formatTime(remaining)}`;

                        if (elapsed >= recordingDuration && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                        }
                    }, 200);
                } catch (error) {
                    updateStatus('ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ' + error.message, 'error');
                    status.classList.remove('active');
                    if (activeStream) {
                        activeStream.getTracks().forEach(t => t.stop());
                        activeStream = null;
                    }
                }
            } else {
                if (recordingTimer) clearInterval(recordingTimer);
                if (mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                updateStatus('éŒ²éŸ³åœæ­¢', 'info');
            }
        });

        // éŸ³å£°ç”Ÿæˆãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰
        document.getElementById('buildModelBtn').addEventListener('click', async () => {
            const btn = document.getElementById('buildModelBtn');
            const genBtn = document.getElementById('generateBtn');
            const recBtn = document.getElementById('recordBtn');
            const csvBtn = document.getElementById('csvInputBtn');
            const csvExportBtn = document.getElementById('csvExportBtn');

            btn.disabled = true;
            genBtn.disabled = true;
            recBtn.disabled = true;
            csvBtn.disabled = true;
            csvExportBtn.disabled = true;

            updateStatus('ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰ä¸­', 'info');
            updateProgress(10, 'ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰ä¸­');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 600000);
                const res = await fetch(`${API_BASE}/api/build_voice_model`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}),
                    signal: controller.signal,
                });
                clearTimeout(timeoutId);

                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(t);
                }

                updateProgress(100, 'å®Œäº†');
                updateStatus('ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰å®Œäº†', 'success');
                setTimeout(() => updateProgress(0), 1500);
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateStatus('ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰å¤±æ•—: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ600ç§’è¶…éï¼‰', 'error');
                } else {
                    updateStatus('ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰å¤±æ•—: ' + error.message, 'error');
                }
                updateProgress(0);
            } finally {
                btn.disabled = false;
                genBtn.disabled = false;
                recBtn.disabled = false;
                csvBtn.disabled = false;
                csvExportBtn.disabled = false;
            }
        });

        // éŸ³å£°ç”Ÿæˆ
        document.getElementById('generateBtn').addEventListener('click', async () => {
            if (currentRows.length === 0) {
                updateStatus('åŸç¨¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', 'error');
                return;
            }

            // åŸç¨¿ãŒç©ºï¼ˆå…¨è¡Œç©ºç™½ï¼‰ãªã‚‰ã‚¨ãƒ©ãƒ¼
            const hasAnyScript = currentRows.some(s => (s && s.script && String(s.script).trim().length > 0));
            if (!hasAnyScript) {
                updateStatus('åŸç¨¿ãƒªã‚¹ãƒˆãŒç©ºã§ã™ï¼ˆscriptãŒç©ºç™½ï¼‰', 'error');
                return;
            }

            firstPlayableAudioUrl = null;

            // å†ç”Ÿä¸­ã®éŸ³å£°ãŒã‚ã‚‹ã¨ Windows ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã€ä¸Šæ›¸ãã«å¤±æ•—ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
            // ç”Ÿæˆå‰ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åœæ­¢ã—ã¦å‚ç…§ã‚’å¤–ã™ã€‚
            try {
                const ap = document.getElementById('audioPlayer');
                ap.pause();
                ap.removeAttribute('src');
                ap.load();
            } catch {
                // ignore
            }

            updateStatus(`éŸ³å£°ç”Ÿæˆä¸­ï¼ˆå‡¦ç†ä¸­ 0/${currentRows.length}ï¼‰`, 'info');
            updateProgress(0);

            // ç”Ÿæˆä¸­ã¯èª¤æ“ä½œé˜²æ­¢
            const btn = document.getElementById('generateBtn');
            const csvExportBtn = document.getElementById('csvExportBtn');
            btn.disabled = true;
            csvExportBtn.disabled = true;

            try {
                // output/temp ã‚’äº‹å‰ã«å…¨å‰Šé™¤ï¼ˆå¤±æ•—ã—ãŸã‚‰æ­¢ã‚ã‚‹ï¼‰
                const clearRes = await fetch(`${API_BASE}/api/clear_temp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scope: null }),
                });
                if (!clearRes.ok) {
                    const t = await clearRes.text();
                    throw new Error(`tempå‰Šé™¤ã«å¤±æ•—: ${t}`);
                }

                // ä¸€æ‹¬ç”Ÿæˆã¯ã‚µãƒ¼ãƒãƒ¼å¿œç­”ãŒé•·æ™‚é–“ãƒ–ãƒ­ãƒƒã‚¯ã—ã‚„ã™ã„ã€‚
                // UIå´ã§ 1è¡Œãšã¤ç”Ÿæˆã—ã¦é€²æ—ï¼ˆå‡¦ç†ä¸­/å…¨æ•°ï¼‰ã‚’è¡¨ç¤ºã—ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å›é¿ã™ã‚‹ã€‚
                const total = currentRows.length;
                let done = 0;
                let generatedAny = false;

                for (const row of currentRows) {
                    const script = (row && row.script !== undefined) ? String(row.script) : '';
                    const idx = (row && row.index !== undefined) ? row.index : 0;

                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 600000);

                    // åˆå›ã®ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å¾…ã¡ã‚’ã€202(warming)ã§å¸åã—ã¦ã€Œ0/20ã§å›ºã¾ã‚‹ã€çŠ¶æ…‹ã‚’å›é¿
                    let res = null;
                    for (let attempt = 0; attempt < 900; attempt++) { // æœ€å¤§ç´„30åˆ†
                        res = await fetch(`${API_BASE}/api/generate_audio`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ index: idx, script: script, overwrite: true }),
                            signal: controller.signal,
                        });

                        if (res.status === 202) {
                            let j = null;
                            try { j = await res.json(); } catch { j = null; }
                            const stage = (j && j.tts && j.tts.stage) ? String(j.tts.stage) : 'warming';
                            updateProgress(0, `ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–ä¸­: ${stage}`);
                            updateStatus(`ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–ä¸­ï¼ˆå‡¦ç†ä¸­ ${done}/${total}ï¼‰: ${stage}`, 'info');
                            await new Promise(r => setTimeout(r, 2000));
                            continue;
                        }
                        break;
                    }
                    clearTimeout(timeoutId);

                    if (!res.ok) {
                        const errorText = await res.text();
                        throw new Error(`index=${idx}: ${errorText}`);
                    }

                    const data = await res.json();
                    if (!generatedAny && data && data.path) {
                        generatedAny = true;
                        firstPlayableAudioUrl = data.audio_url || `/output/voice_${String(idx).padStart(3, '0')}.mp3`;
                    }

                    done += 1;
                    const percent = total ? (done / total) * 100 : 0;
                    updateProgress(percent, `å‡¦ç†ä¸­ ${done}/${total}`);
                    updateStatus(`éŸ³å£°ç”Ÿæˆä¸­ï¼ˆå‡¦ç†ä¸­ ${done}/${total}ï¼‰`, 'info');
                }

                updateProgress(100, 'å®Œäº†');
                updateStatus('éŸ³å£°ç”Ÿæˆå®Œäº†', 'success');
                setTimeout(() => updateProgress(0), 2000);
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateStatus('éŸ³å£°ç”Ÿæˆå¤±æ•—: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ600ç§’è¶…éï¼‰: ã‚µãƒ¼ãƒãƒ¼å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                } else {
                    updateStatus('éŸ³å£°ç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
                }
                updateProgress(0);
            } finally {
                btn.disabled = false;
                csvExportBtn.disabled = false;
            }
        });

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>
</html>
